name: pages-ops

on:
  schedule:
    - cron: "20 5 * * *"
    - cron: "35 5 * * 1"
  workflow_dispatch:
    inputs:
      include_link_check:
        description: "Weekly-style external link check zusaetzlich ausfuehren"
        required: true
        default: true
        type: boolean

concurrency:
  group: pages-ops-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  health-check:
    name: Production Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Run health checks
        run: npm run pages:health
        env:
          SITE_URL: ${{ vars.PAGES_SITE_URL }}

  link-check:
    name: External Link Check
    runs-on: ubuntu-latest
    needs: health-check
    timeout-minutes: 15
    if: ${{ (github.event_name == 'workflow_dispatch' && inputs.include_link_check) || github.event.schedule == '35 5 * * 1' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run lychee link check
        uses: lycheeverse/lychee-action@v2
        with:
          fail: true
          args: >-
            --verbose
            --no-progress
            --max-retries 2
            --retry-wait-time 2
            --accept 200,206,429
            --exclude-mail
            --exclude '^https://fonts.googleapis.com/.*'
            --exclude '^https://fonts.gstatic.com/.*'
            --exclude '^https://www.instagram.com/.*'
            --base https://www.bembelracingteam.de
            index.html
            team.html
            sponsoring-anfrage.html
            404.html
